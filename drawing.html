<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	
	<title>Realtime Drawing Board</title>
	    
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; touch-action: none; }
        canvas { display: block; background-color: #ffffff; cursor: crosshair; }
		
        #status { 
            position: absolute; top: 15px; left: 15px; 
            padding: 8px 12px; background: rgba(0,0,0,0.6); 
            color: white; border-radius: 20px; font-size: 14px;
            font-family: sans-serif; pointer-events: none; 
            user-select: none;
        }
		
		.toolbar {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tool-btn {
            border: none; background: #eee;
            width: 50px; height: 50px;
            border-radius: 50%;
            font-size: 24px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }

        /* ì„ íƒëœ ë„êµ¬ ê°•ì¡° */
        .tool-btn.active {
            background: #333; color: white;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
		
		/* ì „ì²´ ì‚­ì œ ë²„íŠ¼ (ë¹¨ê°„ìƒ‰) */
        .btn-clear {
            color: #ff4444; background: #fff0f0;
        }
        .btn-clear:active {
            background: #ff4444; color: white;
        }
    </style>
</head>
<body>

    <div id="status">ì—°ê²° ëŒ€ê¸°ì¤‘...</div>
    <canvas id="drawCanvas"></canvas>

	<div class="toolbar">
        <button id="btn-pen" class="tool-btn active" onclick="setTool('pen')">âœï¸</button>
        <button id="btn-eraser" class="tool-btn" onclick="setTool('eraser')">ğŸ§½</button>
        <div style="width: 1px; background: #ddd; margin: 0 5px;"></div> <button id="btn-clear" class="tool-btn btn-clear" onclick="clearAll()">ğŸ—‘ï¸</button>
    </div>
	
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ==========================================
        // 1. Firebase ì„¤ì • (ì´ ë¶€ë¶„ì„ ë³¸ì¸ ê²ƒìœ¼ë¡œ êµì²´í•˜ì„¸ìš”)
        // ==========================================
        const firebaseConfig = {
			apiKey: "AIzaSyB963SIu9GvMryYljRDXwRg8MBQ4Uh_5RU",
		  authDomain: "referencedrawing-9c65e.firebaseapp.com",
		  databaseURL: "https://referencedrawing-9c65e-default-rtdb.asia-southeast1.firebasedatabase.app",
		  projectId: "referencedrawing-9c65e",
		  storageBucket: "referencedrawing-9c65e.firebasestorage.app",
		  messagingSenderId: "199968833624",
		  appId: "1:199968833624:web:c9c0049c303011f8298a2d"
        };
        // ==========================================

        // Firebase ì´ˆê¸°í™” [ì‹ ë¢°: Google Firebase ê³µì‹ ë¬¸ì„œ ê¸°ì¤€]
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        const linesRef = db.ref('lines'); // 'lines'ë¼ëŠ” ë°©ì— ë°ì´í„° ì €ì¥

        // ìº”ë²„ìŠ¤ ì„¤ì •
        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // í™”ë©´ í¬ê¸° ë§ì¶¤
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // ==========================================
        // 2. ê·¸ë¦¬ê¸° ë¡œì§ (ì…ë ¥ -> Firebase ì „ì†¡)
        // ==========================================
        
        function setTool(tool) {
            currentTool = tool;
            
            // UI ì—…ë°ì´íŠ¸ (ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½)
            document.getElementById('btn-pen').classList.remove('active');
            document.getElementById('btn-eraser').classList.remove('active');

            if (tool === 'pen') {
                document.getElementById('btn-pen').classList.add('active');
                currentColor = '#000000';
                currentWidth = 2;
            } else if (tool === 'eraser') {
                document.getElementById('btn-eraser').classList.add('active');
                currentColor = '#ffffff'; // ë°°ê²½ìƒ‰ê³¼ ê°™ì€ í°ìƒ‰ìœ¼ë¡œ ë®ìŒ
                currentWidth = 30;        // ì§€ìš°ê°œëŠ” íœë³´ë‹¤ ë‘ê»ê²Œ
            }
        }

        // ì „ì²´ ì‚­ì œ ë¡œì§
        function clearAll() {
            if(confirm("ëª¨ë“  ê·¸ë¦¼ì„ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                linesRef.remove(); // ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë¹„ì›€ -> ëª¨ë“  ê¸°ê¸°ì—ì„œ child_removed ì´ë²¤íŠ¸ ë°œìƒ
            }
        }

        // ----------------------------------------
        // 2. ê·¸ë¦¬ê¸° ë¡œì§ (Input -> Firebase)
        // ----------------------------------------
        function getPos(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        function startDrawing(e) {
            if(e.target.closest('.toolbar')) return; // íˆ´ë°” í„°ì¹˜ ì‹œ ê·¸ë¦¬ê¸° ë°©ì§€
            isDrawing = true;
            const pos = getPos(e);
            lastX = pos.x; lastY = pos.y;
        }

        function stopDrawing() { isDrawing = false; }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€

            const pos = getPos(e);
            
            // ë‚´ í™”ë©´ì— ë¨¼ì € ê·¸ë¦¬ê¸° (ë°˜ì‘ì†ë„ í–¥ìƒ)
            drawLine(lastX, lastY, pos.x, pos.y, currentColor, currentWidth);

            // ì„œë²„ë¡œ ì „ì†¡ (í˜„ì¬ ì„ íƒëœ ìƒ‰ìƒê³¼ ë‘ê»˜ë¥¼ ë³´ëƒ„)
            linesRef.push({
                x0: lastX, y0: lastY,
                x1: pos.x, y1: pos.y,
                color: currentColor,
                width: currentWidth
            });

            lastX = pos.x; lastY = pos.y;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);

        // ----------------------------------------
        // 3. ë™ê¸°í™” ë¡œì§ (Firebase -> Output)
        // ----------------------------------------
        linesRef.on('child_added', (snapshot) => {
            const data = snapshot.val();
            drawLine(data.x0, data.y0, data.x1, data.y1, data.color, data.width);
            statusDiv.innerText = "â— ì‹¤ì‹œê°„ ì—°ë™ë¨";
            statusDiv.style.color = "#4caf50"; // ë…¹ìƒ‰ í…ìŠ¤íŠ¸
        });

        // ëˆ„êµ°ê°€ ì „ì²´ ì‚­ì œë¥¼ ëˆŒë €ì„ ë•Œ
        linesRef.on('child_removed', () => {
            // child_removedëŠ” ë°ì´í„°ê°€ í•˜ë‚˜ì”© ì§€ì›Œì§ˆ ë•Œë§ˆë‹¤ ë°œìƒí•  ìˆ˜ ìˆìŒ.
            // ì„±ëŠ¥ì„ ìœ„í•´ "í™”ë©´ ì „ì²´ ì§€ìš°ê¸°"ëŠ” í•œ ë²ˆë§Œ ìˆ˜í–‰í•˜ë„ë¡ requestAnimationFrame ì‚¬ìš© ê°€ëŠ¥í•˜ë‚˜,
            // ê°„ë‹¨í•˜ê²ŒëŠ” clearRectë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        // ì²˜ìŒ ë¡œë”© ì‹œ ì „ì²´ ë¦¬ì…‹ ê°ì§€ (ë°ì´í„°ê°€ ì—†ì„ ë•Œ)
        linesRef.on('value', (snapshot) => {
            if(!snapshot.exists()) {
                 ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        });

        function drawLine(x0, y0, x1, y1, color, width) {
            ctx.beginPath();
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y1);
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            ctx.lineCap = 'round'; 
            ctx.lineJoin = 'round';
            ctx.stroke();
            ctx.closePath();
        }

        // ì´ˆê¸°í™” ë²„íŠ¼ (ì½˜ì†”ì—ì„œ db.ref('lines').remove() ì‹¤í–‰ ì‹œ í™”ë©´ ì§€ì›€)
        linesRef.on('child_removed', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        statusDiv.innerText = "ì—°ê²°ë¨ (ê·¸ë¦¬ê¸° ê°€ëŠ¥)";

    </script>
</body>
</html>