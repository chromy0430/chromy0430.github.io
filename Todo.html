<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Kanban Board</title>
    <style>
        :root {
            --bg-color: #a54b68;
            --sidebar-bg: #1e1e1e;
            --column-bg: #101204;
            --text-color: #b6c2cf;
            --accent-color: #579dff;
            --danger-color: #ff5555;
            
            /* Tab Colors */
            --tab-inactive: rgba(0,0,0,0.3);
            --tab-active: #ffffff;
            --tab-text-active: #000;

            /* Priority Colors */
            --card-color-default: #22272b; 
            --card-color-low: #2d4a3e;    
            --card-color-medium: #6b5b2b; 
            --card-color-high: #854c1d;    
            --card-color-critical: #6e2121;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar (History) --- */
        #sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            border-bottom: 1px solid #333;
            color: #ddd;
        }

        #history-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .history-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
            transition: background 0.2s;
            color: #888;
            font-size: 0.9rem;
        }
        .history-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .history-item.active { background: var(--accent-color); color: #fff; font-weight: bold; }

        /* --- Main Area --- */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* --- Top Bar (Tabs & Controls) --- */
        #top-bar {
            padding: 10px 20px 0 20px; /* Bottom padding removed for tabs */
            background: rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: flex-end; /* Align tabs to bottom */
            height: 50px;
        }

        #tabs-container {
            display: flex;
            gap: 5px;
        }

        .tab {
            padding: 10px 20px;
            background: var(--tab-inactive);
            color: #ccc;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
            user-select: none;
            transition: all 0.2s;
        }
        
        .tab:hover { background: rgba(255,255,255,0.1); }
        
        .tab.active {
            background: var(--tab-active);
            color: var(--tab-text-active);
            transform: translateY(0);
        }

        .top-controls {
            padding-bottom: 10px;
            display: flex;
            gap: 10px;
        }

        button.control-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #eee;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        button.control-btn:hover { background: white; color: black; }

        /* --- Board Layout --- */
        #board {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            gap: 15px;
            overflow-x: auto;
            height: 100%;
        }

        /* Viewing History Warning Bar */
        #history-warning {
            background: var(--danger-color);
            color: white;
            text-align: center;
            padding: 5px;
            font-weight: bold;
            display: none;
        }

        .column {
            background-color: var(--column-bg);
            border-radius: 12px;
            width: 300px;
            min-width: 300px;
            max-height: calc(100% - 40px);
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .column-header {
            padding: 8px; font-weight: bold; color: #fff;
            display: flex; justify-content: space-between;
        }

        .card-list {
            flex-grow: 1; overflow-y: auto; min-height: 50px; padding-bottom: 10px;
        }

        /* Card & Colors */
        .card {
            background-color: var(--this-card-bg, var(--card-color-default));
            border-radius: 8px; padding: 10px; margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            position: relative;
            padding-bottom: 25px; /* Space for dots */
            cursor: grab;
        }
        .card:active { cursor: grabbing; }
        .card-text { word-wrap: break-word; }

        .color-picker-container {
            position: absolute; bottom: 5px; left: 10px; display: flex; gap: 5px;
        }
        .color-dot {
            width: 12px; height: 12px; border-radius: 50%; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .color-dot:hover { transform: scale(1.2); border-color: white; }

        .dot-default { background: var(--card-color-default); }
        .dot-low { background: var(--card-color-low); }
        .dot-medium { background: var(--card-color-medium); }
        .dot-high { background: var(--card-color-high); }
        .dot-critical { background: var(--card-color-critical); }

        /* Buttons */
        .add-card-btn, .new-column-btn {
            width: 100%; text-align: left; background: transparent;
            color: #9fadbc; border: none; padding: 8px; cursor: pointer;
        }
        .add-card-btn:hover { background: rgba(255,255,255,0.1); }
        
        .new-column-btn { 
            min-width: 300px; background: rgba(0,0,0,0.2); 
            border-radius: 12px; padding: 15px; text-align: center; 
        }

        .delete-btn {
            position: absolute; right: 5px; top: 5px;
            background: none; border: none; color: rgba(255,255,255,0.3); cursor: pointer;
        }
        .delete-btn:hover { color: var(--danger-color); }

        /* Read Only Mode (History) */
        body.read-only .card { cursor: default; padding-bottom: 10px; }
        body.read-only .color-picker-container,
        body.read-only .add-card-btn,
        body.read-only .delete-btn,
        body.read-only .new-column-btn { display: none !important; }
        body.read-only .column-header span { pointer-events: none; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <span id="sidebar-title">History Log</span>
        </div>
        <div id="history-list">
            </div>
    </div>

    <div id="main-content">
        <div id="top-bar">
            <div id="tabs-container">
                </div>
            <div class="top-controls">
                <button class="control-btn" onclick="renameCurrentTab()">‚úé Rename Tab</button>
            </div>
        </div>

        <div id="history-warning">‚ö†Ô∏è VIEWING PAST HISTORY (READ ONLY) - Click 'Current' in sidebar to edit</div>

        <div id="board">
            <button class="new-column-btn" onclick="createNewColumn()">+ Add another list</button>
        </div>
    </div>

    <script>
        // --- 1. Configuration & State ---
        const DATA_PREFIX = "kanban_data_";
        const HIST_PREFIX = "kanban_hist_";
        const META_KEY = "kanban_meta_tabs"; // Stores tab names/IDs

        // Default Tabs if none exist
        const DEFAULT_TABS = [
            { id: 'user_a', name: 'User A' },
            { id: 'user_b', name: 'User B' }
        ];

        let tabs = [];
        let activeTabId = null;
        let viewingHistoryDate = null; // null = Current (Editable), '2026-02-05' = ReadOnly
        let boardData = { columns: [] };

        const COLOR_OPTIONS = ['default', 'low', 'medium', 'high', 'critical'];

        // --- 2. Initialization ---
        window.onload = () => {
            loadTabs();
            renderTabs();
            // Load first tab by default
            switchTab(tabs[0].id);
        };

        // --- 3. Tab Management ---
        function loadTabs() {
            const savedMeta = localStorage.getItem(META_KEY);
            if (savedMeta) {
                tabs = JSON.parse(savedMeta);
            } else {
                tabs = DEFAULT_TABS;
                saveTabs();
            }
        }

        function saveTabs() {
            localStorage.setItem(META_KEY, JSON.stringify(tabs));
        }

        function renderTabs() {
            const container = document.getElementById('tabs-container');
            container.innerHTML = "";
            
            tabs.forEach(tab => {
                const tabEl = document.createElement('div');
                tabEl.className = `tab ${tab.id === activeTabId ? 'active' : ''}`;
                tabEl.innerText = tab.name;
                tabEl.onclick = () => switchTab(tab.id);
                container.appendChild(tabEl);
            });
        }

        function switchTab(tabId) {
            activeTabId = tabId;
            viewingHistoryDate = null; // Always reset to Current when switching tabs
            renderTabs();
            
            // Update Sidebar Title to show whose history it is
            const tabName = tabs.find(t => t.id === tabId).name;
            document.getElementById('sidebar-title').innerText = `${tabName}'s Log`;

            loadBoardData(null); // Load current data
            loadHistoryList();   // Load filtered history
        }

        function renameCurrentTab() {
            const currentTab = tabs.find(t => t.id === activeTabId);
            const newName = prompt("Enter new name for this tab:", currentTab.name);
            if (newName && newName.trim() !== "") {
                currentTab.name = newName.trim();
                saveTabs();
                renderTabs();
                document.getElementById('sidebar-title').innerText = `${currentTab.name}'s Log`;
            }
        }

        // --- 4. Data Logic (Separated by Tab ID) ---
        
        function getStorageKey(dateStr) {
            // Key format: kanban_data_{tabId} OR kanban_hist_{tabId}_{date}
            if (dateStr) return `${HIST_PREFIX}${activeTabId}_${dateStr}`;
            return `${DATA_PREFIX}${activeTabId}`;
        }

        function getTodayString() {
            const date = new Date();
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function saveBoard() {
            if (viewingHistoryDate !== null) return; // Prevent saving if viewing history

            // Serialize DOM
            const columnsDOM = document.querySelectorAll('.column');
            const newColumnsData = [];
            columnsDOM.forEach(col => {
                const title = col.querySelector('.column-title').innerText;
                const cardsDOM = col.querySelectorAll('.card');
                const cardObjects = [];
                cardsDOM.forEach(card => {
                    cardObjects.push({
                        text: card.querySelector('.card-text').innerText,
                        color: card.dataset.color || 'default'
                    });
                });
                newColumnsData.push({ id: col.id, title: title, cards: cardObjects });
            });
            boardData.columns = newColumnsData;

            const jsonStr = JSON.stringify(boardData);
            
            // 1. Save Current
            localStorage.setItem(getStorageKey(null), jsonStr);
            
            // 2. Save History (Tab-Specific)
            localStorage.setItem(getStorageKey(getTodayString()), jsonStr);
            
            loadHistoryList(); // Refresh sidebar in case today is new
        }

        function loadBoardData(dateStr) {
            viewingHistoryDate = dateStr;
            const key = getStorageKey(dateStr);
            const saved = localStorage.getItem(key);

            // UI Mode Update
            const warning = document.getElementById('history-warning');
            const addColBtn = document.querySelector('.new-column-btn');

            if (dateStr !== null) {
                // History Mode
                document.body.classList.add('read-only');
                warning.style.display = 'block';
                addColBtn.style.display = 'none';
            } else {
                // Edit Mode
                document.body.classList.remove('read-only');
                warning.style.display = 'none';
                addColBtn.style.display = 'block';
            }

            if (saved) {
                boardData = JSON.parse(saved);
            } else if (dateStr === null) {
                // Init Empty Board for new user
                boardData = { columns: [
                    { id: 'c1', title: 'To Do', cards: [] },
                    { id: 'c2', title: 'Doing', cards: [] },
                    { id: 'c3', title: 'Done', cards: [] }
                ]};
            }

            renderBoard();
            highlightSidebar();
        }

        // --- 5. History Sidebar (Filtered) ---
        function loadHistoryList() {
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = "";

            // "Current" Button
            const curBtn = document.createElement('div');
            curBtn.className = 'history-item';
            curBtn.innerText = "‚ö° Current (Latest)";
            curBtn.dataset.val = "current";
            curBtn.onclick = () => loadBoardData(null);
            listEl.appendChild(curBtn);

            // Find Keys for CURRENT TAB ONLY
            const keys = [];
            const prefix = `${HIST_PREFIX}${activeTabId}_`;
            
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k.startsWith(prefix)) {
                    keys.push(k.replace(prefix, ""));
                }
            }
            keys.sort().reverse();

            keys.forEach(dateStr => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerText = dateStr;
                item.dataset.val = dateStr;
                item.onclick = () => loadBoardData(dateStr);
                listEl.appendChild(item);
            });
            highlightSidebar();
        }

        function highlightSidebar() {
            const items = document.querySelectorAll('.history-item');
            items.forEach(i => i.classList.remove('active'));
            
            const targetVal = viewingHistoryDate === null ? "current" : viewingHistoryDate;
            const target = Array.from(items).find(i => i.dataset.val === targetVal);
            if (target) target.classList.add('active');
        }

        // --- 6. Rendering & DnD ---
        const boardEl = document.getElementById('board');
        const addColBtn = document.querySelector('.new-column-btn');

        function renderBoard() {
            const cols = document.querySelectorAll('.column');
            cols.forEach(c => c.remove());

            boardData.columns.forEach(colData => {
                createColumnElement(colData.title, colData.cards, colData.id);
            });
        }

        function createColumnElement(title, cards, id) {
            const col = document.createElement('div');
            col.className = 'column';
            col.id = id || 'col-' + Date.now();

            const header = document.createElement('div');
            header.className = 'column-header';
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'column-title';
            titleSpan.innerText = title;
            titleSpan.contentEditable = true;
            titleSpan.onblur = saveBoard;

            const delBtn = document.createElement('span');
            delBtn.innerHTML = '&times;';
            delBtn.style.cursor='pointer';
            delBtn.onclick = () => { if(confirm('Delete List?')) {col.remove(); saveBoard();} };

            header.appendChild(titleSpan);
            header.appendChild(delBtn);

            const cardList = document.createElement('div');
            cardList.className = 'card-list';
            
            // Drag Logic
            cardList.addEventListener('dragover', e => {
                if(viewingHistoryDate) return;
                e.preventDefault();
                const afterElement = getDragAfterElement(cardList, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (afterElement == null) cardList.appendChild(dragging);
                else cardList.insertBefore(dragging, afterElement);
            });
            cardList.addEventListener('drop', () => { if(!viewingHistoryDate) saveBoard(); });

            cards.forEach(cData => addCardDOM(cardList, cData));

            const addCardBtn = document.createElement('button');
            addCardBtn.className = 'add-card-btn';
            addCardBtn.innerText = '+ Add a card';
            addCardBtn.onclick = () => {
                const t = prompt('Card Title:');
                if(t) { addCardDOM(cardList, {text: t, color: 'default'}); saveBoard(); }
            };

            col.appendChild(header);
            col.appendChild(cardList);
            col.appendChild(addCardBtn);
            
            boardEl.insertBefore(col, addColBtn);
        }

        function addCardDOM(container, cardData) {
            const card = document.createElement('div');
            card.className = 'card';
            card.draggable = true;
            const colorKey = cardData.color || 'default';
            card.style.setProperty('--this-card-bg', `var(--card-color-${colorKey})`);
            card.dataset.color = colorKey;

            const textDiv = document.createElement('div');
            textDiv.className = 'card-text';
            textDiv.innerText = cardData.text;
            card.appendChild(textDiv);

            const del = document.createElement('button');
            del.className = 'delete-btn';
            del.innerText = 'üóë';
            del.onclick = (e) => { e.stopPropagation(); card.remove(); saveBoard(); };
            card.appendChild(del);

            const pickerContainer = document.createElement('div');
            pickerContainer.className = 'color-picker-container';
            COLOR_OPTIONS.forEach(opt => {
                const dot = document.createElement('div');
                dot.className = `color-dot dot-${opt}`;
                dot.onclick = (e) => {
                    e.stopPropagation();
                    card.style.setProperty('--this-card-bg', `var(--card-color-${opt})`);
                    card.dataset.color = opt;
                    saveBoard();
                };
                pickerContainer.appendChild(dot);
            });
            card.appendChild(pickerContainer);

            card.addEventListener('dragstart', () => {
                if(!viewingHistoryDate) card.classList.add('dragging');
                else return false;
            });
            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                saveBoard();
            });

            container.appendChild(card);
        }

        function createNewColumn() {
            const t = prompt('New List Title:');
            if(t) { createColumnElement(t, []); saveBoard(); }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

    </script>
</body>
</html>